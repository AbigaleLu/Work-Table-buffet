<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>自选电镜机时日历 · V2</title>
<style>

  :root{
    --Spectra300: #d08c90;
    --hf5000: #8eaacb;
    --f20: #b7b7b7;
    --rest: #f4e8a9;
    --today: #deefdf;
  }
  body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Noto Sans CJK SC",sans-serif;margin:0;background:#fafafa;color:#111;}
  header{position:sticky;top:0;background:#fff;border-bottom:1px solid #eee;z-index:10}
  .toolbar{max-width:980px;margin:0 auto;display:flex;align-items:center;gap:12px;padding:10px 12px;flex-wrap:wrap}
  .title{font-weight:700}
  .seg{display:inline-flex;border:1px solid #ddd;border-radius:12px;overflow:hidden}
  .seg button{border:0;padding:8px 12px;background:#fff;cursor:pointer;font-weight:600}
  .seg button.active{background:#111;color:#fff}
  select, .btn{padding:8px 10px;border:1px solid #ddd;border-radius:10px;background:#fff;cursor:pointer}
  /* 修改 legend 样式以左对齐 */
  .legend{display:flex;gap:8px;align-items:center;flex-wrap:wrap; margin-left: 0; }
  .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;background:#fff;box-shadow:0 1px 3px rgba(0,0,0,.06);font-size:13px}
  .dot{width:10px;height:10px;border-radius:50%}
  .container{max-width:980px;margin:16px auto;padding:0 12px}
  .month{display:none;background:#fff;border-radius:16px;box-shadow:0 6px 20px rgba(0,0,0,.08);padding:16px;touch-action:pan-y}
  .month.active{display:block}
  .month h2{margin:0 0 8px 0;font-size:18px;font-weight:700;text-align:center}
  .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
  .dow{font-size:12px;font-weight:600;text-align:center;color:#666;padding:6px 0}
  .day{background:#f7f7f8;border-radius:12px;min-height:96px;padding:8px;display:flex;flex-direction:column;transition:transform .12s ease, background .2s ease}
  .day .num{font-size:12px;color:#666;margin-bottom:6px}
  .day.other{opacity:.35}
  .day.today{background:var(--today); box-shadow: inset 0 0 0 1px rgba(0,0,0,.04);}
  .badges{display:flex;flex-wrap:wrap;gap:6px;margin-top:auto}
  .badge{font-size:12px;font-weight:700;line-height:1;padding:6px 8px;border-radius:10px;color:#111}
  .badge.sp{background:var(--Spectra300);color:#fbfbfb;}
  .badge.hf{background:var(--hf5000);color:#fbfbfb;}
  .badge.f20{background:var(--f20);color:#fbfbfb;}
  .badge.rest{background:var(--rest);color:#303030;}
  .btn-today{font-weight:700}
  /* 新增：页脚样式 */
  footer{
    margin-top: 32px;
    margin-bottom: 24px;
    font-size: 13px;
    color: #999;
    text-align: center;
  }


/* 下拉面板（不改变原有样式，仅新增） */
.dropdown-container{position:relative;display:inline-block}
.dropdown-menu{display:none;position:absolute;right:0;top:42px;background:#fff;min-width:280px;border:1px solid #eee;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.12);padding:12px;z-index:1000}
.dropdown-menu.open{display:block}
.dropdown-menu label{font-weight:700;font-size:14px;margin-bottom:6px;display:block}
.dropdown-menu .row{display:flex;align-items:center;gap:8px;margin:6px 0;font-size:12px}
.dropdown-menu select,.dropdown-menu input{
  padding:6px 8px;
  border:1px solid #ddd;
  border-radius:8px;
  background:#f7f7f8;
  font-size:12px;
  max-width: 103px; /* 新增样式：限制输入框的最大宽度 */
}
.dropdown-menu hr{border:0;border-top:1px solid #eee;margin:10px 0}
#save-rules{width:100%;font-weight:800}

/* 过去日期弱化显示 */
.day.past { opacity: .55; }

</style>
</head>
<body>

<header>
  <div class="toolbar">
    <span class="title">自选电镜机时日历</span>
    <div class="seg" id="monthSeg"></div>
    <select id="filter">
      <option value="ALL">全部机台</option>
      <option value="Spectra300">只看 Spectra300</option>
      <option value="Hf5000">只看 Hf5000</option>
      <option value="F20">只看 F20</option>
    </select>
    <button class="btn" id="btn-export">导出 ICS（日程订阅）</button>
    <button class="btn btn-today" id="goToday">回到今天</button>
    <div class="legend">
      <span class="chip"><span class="dot" style="background:var(--Spectra300)"></span>Spectra300</span>
      <span class="chip"><span class="dot" style="background:var(--hf5000)"></span>Hf5000</span>
      <span class="chip"><span class="dot" style="background:var(--f20)"></span>F20</span>
      <span class="chip"><span class="dot" style="background:var(--rest)"></span>嘿嘿休息</span>
    </div>
    <div class="dropdown-container">
      <button class="btn" id="ruleBtn">规则设置</button>
      <div class="dropdown-menu" id="ruleMenu">
        <label>Spectra300（6周循环）</label>
        <div class="row">当前是：第
          <select id="select-a"></select> 周
        </div>
        <div class="row">休息周：第
          <select id="select-b"></select> 周
        </div>
        <div class="row">工作日：周
          <select id="select-s"></select>
        </div>
        <hr>
        <label>Hf5000（3周循环）</label>
        <div class="row">从第
          <select id="select-c"></select> 周开始
        </div>
        <div class="row">固定搭配：
          <select id="select-e">
            <option value="MT">周一/周四</option>
            <option value="WT">周三/周二</option>
          </select>
        </div>
        <hr>
        <label>F20/F200</label>
        <div class="row">电镜标签自选：
          <input type="text" id="input-f20-text" value="F20" />
        </div>
       <div class="row">工作日（多日用逗号分隔）：
          <input type="text" id="input-f20-days" value="1,5" />
        </div>
        <button class="btn" id="save-rules">保存</button>
      </div>
    </div>
  </div>
</header>

<div class="container"></div>
<footer>
  © 2025 Abigale · TEM Toolbox (Work Calendar)
</footer>

<script>

/* ========= 参数化机时日历 v2：修正 Hf5000 相位 & 新增 Spectra300 工作日 =========
   变量：
   a: 6周循环：当前周是第 a 周(1..6)
   b: Spectra300 在 6周循环中第 b 周休息(1..6)
   s: Spectra300 的工作日(1..7=Mon..Sun) —— 新增
   c: Hf5000 的三周循环锚点，定义为“当前这一周就是第 c 周”(1..3)
   e: Hf5000 固定搭配：'MT' = Mon/Thu，'WT' = Wed/Tue
   d: F20 每周工作日，逗号分隔(如 "1,5" 表示 Mon & Fri)
   f: F20 标签文本
   周一为一周起点；“今天所在周”为锚点向前后推算相位。
   外观、筛选与交互保持不变。
*/

const COLORS = {
  Spectra300: getComputedStyle(document.documentElement).getPropertyValue('--Spectra300').trim() || '#d08c90',
  Hf5000:     getComputedStyle(document.documentElement).getPropertyValue('--hf5000').trim()     || '#8eaacb',
  F20:        getComputedStyle(document.documentElement).getPropertyValue('--f20').trim()        || '#b7b7b7',
  Rest:       getComputedStyle(document.documentElement).getPropertyValue('--rest').trim()       || '#f4e8a9',
};

// ======== 工具栏加入“规则设置”按钮 ========
(function injectRuleButton(){
  const tb = document.querySelector('.toolbar');
  if(!tb || document.getElementById('ruleBtn')) return;
  const btn = document.createElement('button');
  btn.className = 'btn'; btn.id = 'ruleBtn';
  btn.textContent = '规则设置';
  tb.insertBefore(btn, tb.querySelector('.legend')); // 放在图例前
})();

// ======== 默认变量（可被本地存储覆盖）========
const DEFAULTS = { a:1, b:3, s:3, c:1, e:'MT', d:'1,5', f:'F20' }; // s=3 默认周三

function loadVars(){
  try{
    const raw = localStorage.getItem('ems-vars');
    if(!raw) return {...DEFAULTS};
    const obj = JSON.parse(raw);
    return {...DEFAULTS, ...obj};
  }catch{ return {...DEFAULTS}; }
}
function saveVars(v){ localStorage.setItem('ems-vars', JSON.stringify(v)); }

// 规则设置弹窗：输入 a b s c d e f（顺序更新）
function openRulePrompt(){

  // 打开/关闭下拉面板（并以当前值填充）
  ensureRuleOptions();
  const menu = document.getElementById('ruleMenu');
  if(!menu) return;
  const v = loadVars();
  // 填充值
  const set = (id,val)=>{ const el=document.getElementById(id); if(el) el.value = String(val); };
  set('select-a', v.a);
  set('select-b', v.b);
  set('select-s', v.s);
  set('select-c', v.c);
  set('select-e', v.e);
  set('input-f20-days', v.d);
  set('input-f20-text', v.f);
  // 切换可见
  menu.classList.toggle('open');

}
document.getElementById('ruleBtn')?.addEventListener('click', openRulePrompt);

// ======== 基础日历构建（外观与原版一致）========
const seg       = document.getElementById('monthSeg');
const filterSel = document.getElementById('filter');
const todayBtn  = document.getElementById('goToday');
const container = document.querySelector('.container');

const MONTHS = [
  {y:2025, m:9}, {y:2025, m:10}, {y:2025, m:11}, {y:2025, m:12}
];

function startOfWeek(d){ // 周一为起始
  const x = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  let wd = x.getDay(); // 0..6, Sun..Sat
  wd = (wd===0)?7:wd;  // 1..7, Mon..Sun
  x.setDate(x.getDate() - (wd-1));
  x.setHours(0,0,0,0);
  return x;
}
function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
function isoDate(y,m,d){ return `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`; }
function clampInt(v,min,max){ v = parseInt(v,10); if(isNaN(v)) v=min; return Math.max(min, Math.min(max, v)); }

function buildMonthSection(y,m){
  const section = document.createElement('section');
  section.className = 'month';
  section.dataset.year = y;
  section.dataset.month = String(m).padStart(2,'0');
  section.innerHTML = `<h2>${y}年 ${String(m).padStart(2,'0')}月</h2>
    <div class="grid">
      <div class="dow">Mon</div><div class="dow">Tue</div><div class="dow">Wed</div>
      <div class="dow">Thu</div><div class="dow">Fri</div><div class="dow">Sat</div><div class="dow">Sun</div>
    </div>`;
  const grid = section.querySelector('.grid');

  const first = new Date(y, m-1, 1);
  const last  = new Date(y, m, 0);
  const from = startOfWeek(first);
  const to   = addDays(startOfWeek(addDays(last, 6)), 6);

  const today = new Date();
  today.setHours(0,0,0,0);
  for(let d=new Date(from); d<=to; d=addDays(d,1)){
    const inMonth = (d.getMonth() === (m-1));
    const cell = document.createElement('div');
    cell.className = 'day' + (inMonth ? '' : ' other');
    cell.dataset.date = isoDate(d.getFullYear(), d.getMonth()+1, d.getDate());
    cell.innerHTML = `<div class="num">${d.getDate()}</div><div class="badges"></div>`;
    
    // 如果日期在今天之前，则添加 past 类
    if (d < today) {
      cell.classList.add('past');
    }

    section.querySelector('.grid').appendChild(cell);
  }
  return section;
}
function clearAndBuildMonths(){
  container.innerHTML = '';
  MONTHS.forEach(({y,m})=> container.appendChild(buildMonthSection(y,m)));
}
function buildSegButtons(){
  if(!seg) return;
  seg.innerHTML = '';
  MONTHS.forEach(({y,m},i)=>{
    const b = document.createElement('button');
    b.dataset.target = `${y}-${String(m).padStart(2,'0')}`;
    b.textContent = `${y}-${String(m).padStart(2,'0')}`;
    if(i===0) b.classList.add('active');
    seg.appendChild(b);
  });
}
function showMonth(key){
  const sections = [...document.querySelectorAll('.month')];
  sections.forEach(sec=>sec.classList.toggle('active', `${sec.dataset.year}-${sec.dataset.month}`===key));
  [...seg.querySelectorAll('button')].forEach(b=>b.classList.toggle('active', b.dataset.target===key));
  applyFilter(); highlightToday();
}
seg.addEventListener('click', e=>{
  const btn = e.target.closest('button'); if(!btn) return; showMonth(btn.dataset.target);
});
window.addEventListener('keydown', e=>{
  if(e.key!=='ArrowLeft' && e.key!=='ArrowRight') return;
  const sections = [...document.querySelectorAll('.month')];
  const order = sections.map(sec => `${sec.dataset.year}-${sec.dataset.month}`);
  const idx = order.indexOf(order.find(k=>document.querySelector(`.month[data-year="${k.split('-')[0]}"][data-month="${k.split('-')[1]}"]`).classList.contains('active')));
  const next = (e.key==='ArrowRight') ? Math.min(order.length-1, idx+1) : Math.max(0, idx-1);
  showMonth(order[next]);
});

// 用这个完整函数替换你脚本里的 addBadge
function addBadge(dateISO, tag, label){
  const nodes = document.querySelectorAll(`.day[data-date="${dateISO}"] .badges`);
  if(!nodes || nodes.length === 0) return;

  nodes.forEach((el) => {
    const span = document.createElement('span');
    span.className = 'badge ' + (
      tag === 'Spectra300' ? 'sp' :
      tag === 'Hf5000'    ? 'hf' :
      tag === 'F20'       ? 'f20' : 'rest'
    );
    // 便于 ICS 导出和过滤
    span.dataset.tag = tag;
    span.textContent = label;
    el.appendChild(span);
  });
}

function generateSchedule(vars){
  const {a,b,s,c,d,e,f} = vars;

  // —— F20 开关：d 为 '0' 或空白时，F20 完全不渲染 ——
  const dTrim = (d ?? '').toString().trim();
  const f20Enabled = dTrim !== '' && dTrim !== '0';
  const f20Days = f20Enabled
    ? dTrim.split(/[,\s]+/).filter(Boolean)
        .map(x => parseInt(x, 10))
        .filter(n => n >= 1 && n <= 7)   // 只保留 1..7（Mon..Sun）
    : [];

  const f20Text = f || 'F20';

  const today = new Date();
  today.setHours(0,0,0,0); // 去掉时分秒，只比较日期
  const thisWeekMon = startOfWeek(today);

  const from = new Date(2025,8,1);   // 2025-09-01
  const to   = new Date(2025,11,31); // 2025-12-31

  for (let weekMon = startOfWeek(from); weekMon <= to; weekMon = addDays(weekMon, 7)) {
    const weekIdxDelta = Math.round((weekMon - thisWeekMon) / (7*24*3600*1000));

    // ===== 6周循环相位（1..6），当前周对齐为第 a 周 =====
    const cyc6 = (((weekIdxDelta % 6) + 6) % 6) + 1;
    const shift6 = a - 1;
    const cyc6Aligned = ((((cyc6 - 1 + shift6) % 6) + 6) % 6) + 1;

    // ===== Spectra300（s=工作日，b=休息周）=====
    const spDay = addDays(weekMon, s - 1); // s:1..7 => Mon..Sun
    // 检查日期是否在今天或之后，然后才添加徽章
    if (spDay >= from && spDay <= to && spDay >= today) {
      const spISO = isoDate(spDay.getFullYear(), spDay.getMonth()+1, spDay.getDate());
      if (cyc6Aligned === b) {
        addBadge(spISO, 'Rest', '嘿嘿休息');
      } else {
        addBadge(spISO, 'Spectra300', 'Spectra300');
      }
    }

    // ===== Hf5000（三周循环：c周/ c+1周 / c+2休）=====
    const phase3 = (((weekIdxDelta + (c - 1)) % 3) + 3) % 3; // 0=c周,1=c+1,2=休
    let hfOffset = null;
    if (e === 'WT') {        // c周=Wed(2), c+1周=Tue(1), c+2周=休
      hfOffset = (phase3 === 0) ? 2 : (phase3 === 1) ? 1 : null; // Mon=0
    } else {                 // MT：c周=Mon(0), c+1周=Thu(3), c+2周=休
      hfOffset = (phase3 === 0) ? 0 : (phase3 === 1) ? 3 : null;
    }
    if (hfOffset !== null) {
      const hfDate = addDays(weekMon, hfOffset);
      // 检查日期是否在今天或之后，然后才添加徽章
      if (hfDate >= from && hfDate <= to && hfDate >= today) {
        const iso = isoDate(hfDate.getFullYear(), hfDate.getMonth()+1, hfDate.getDate());
        addBadge(iso, 'Hf5000', 'Hf5000');
      }
    }

    // ===== F20（仅在启用时渲染）=====
    if (f20Enabled && f20Days.length > 0) {
      f20Days.forEach(wd => {
        const f20Date = addDays(weekMon, wd - 1);
        // 检查日期是否在今天或之后，然后才添加徽章
        if (f20Date >= from && f20Date <= to && f20Date >= today) {
          const iso = isoDate(f20Date.getFullYear(), f20Date.getMonth()+1, f20Date.getDate());
          addBadge(iso, 'F20', f20Text);
        }
      });
    }
  }
}

// ======== 过滤 / 今天 / 回到今天 ========
filterSel.addEventListener('change', applyFilter);
function applyFilter(){
  const mode = filterSel.value;
  const active = document.querySelector('.month.active');
  if(!active) return;
  active.querySelectorAll('.day').forEach(day=>{
    day.style.display = '';
    day.querySelectorAll('.badge').forEach(b=> b.style.display='');
    if(mode==='ALL') return;
    day.querySelectorAll('.badge').forEach(b=>{
      const tag = b.getAttribute('data-tag');
      if(tag !== mode){
        b.style.display = 'none';
      }
    });
    const visible = [...day.querySelectorAll('.badge')].some(b=>b.style.display!=='none');
    day.style.display = visible ? '' : 'none';
  });
}
function highlightToday(){
  const today = new Date();
  const iso = isoDate(today.getFullYear(), today.getMonth()+1, today.getDate());
  document.querySelectorAll('.day').forEach(day=>day.classList.remove('today'));
  document.querySelectorAll(`.day[data-date="${iso}"]`).forEach(day=>day.classList.add('today'));
}
todayBtn.addEventListener('click', ()=>{
  const now = new Date();
  const key = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  const sections = [...document.querySelectorAll('.month')];
  const order = sections.map(sec => `${sec.dataset.year}-${sec.dataset.month}`);
  if(order.includes(key)) showMonth(key);
  const target = document.querySelector(`.day[data-date="${isoDate(now.getFullYear(),now.getMonth()+1,now.getDate())}"]`);
  if(target){ target.scrollIntoView({behavior:'smooth', block:'center'}); if(navigator.vibrate){ navigator.vibrate([8,30,8]); } }
});

// ======== 初始化 ========
function rebuildAll(vars){
  clearAndBuildMonths();
  buildSegButtons();
  showMonth(`${MONTHS[0].y}-${String(MONTHS[0].m).padStart(2,'0')}`);
  generateSchedule(vars);
  applyFilter();
  highlightToday();
}
const INIT_VARS = loadVars();
rebuildAll(INIT_VARS);




// 规则下拉：确保选项存在
function ensureRuleOptions(){
  function fill(id, start, end){
    const el = document.getElementById(id);
    if(!el) return;
    if(el.options.length>0) return;
    for(let i=start;i<=end;i++){
      const op=document.createElement('option');
      op.value=i; op.text=String(i);
      el.appendChild(op);
    }
  }
  fill('select-a',1,6);
  fill('select-b',1,6);
  fill('select-s',1,7);
  fill('select-c',1,3);
}
ensureRuleOptions();

// ===== 规则下拉保存 =====
document.getElementById('save-rules')?.addEventListener('click', ()=>{
  const v = {
    a: parseInt(document.getElementById('select-a').value,10),
    b: parseInt(document.getElementById('select-b').value,10),
    s: parseInt(document.getElementById('select-s').value,10),
    c: parseInt(document.getElementById('select-c').value,10),
    e: document.getElementById('select-e').value,
    d: (document.getElementById('input-f20-days').value||'').trim(),
    f: (document.getElementById('input-f20-text').value||'').trim()
  };
  saveVars(v);
  rebuildAll(v);
  document.getElementById('ruleMenu').classList.remove('open');
});

// 点击外部关闭
document.addEventListener('click', (e)=>{
  const menu = document.getElementById('ruleMenu');
  const btn = document.getElementById('ruleBtn');
  if(!menu || !btn) return;
  if(menu.contains(e.target) || btn.contains(e.target)) return;
  menu.classList.remove('open');
});

// ===== ICS 导出：将徽标转为全天事件 =====
document.getElementById('btn-export')?.addEventListener('click', ()=>{
  const pad = n=> (n<10?'0':'')+n;
  const now=new Date();
  const dtstamp = now.getUTCFullYear()+pad(now.getUTCMonth()+1)+pad(now.getUTCDate())+'T'+pad(now.getUTCHours())+pad(now.getUTCMinutes())+pad(now.getUTCSeconds())+'Z';
  const lines=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//EM-Schedule//MergedV2//CN'];
  const days=[...document.querySelectorAll('.day')];
  days.forEach(day=>{
    const dateISO=day.dataset.date;
    const y=dateISO.slice(0,4), m=dateISO.slice(5,7), d=dateISO.slice(8,10);
    const ymd=y+m+d;
    const badges=[...day.querySelectorAll('.badge')];
    badges.forEach((b,i)=>{
      const tag = b.dataset.tag;
      let summary=b.textContent.trim();
      if(tag==='Spectra300' && summary.includes('休息')) summary='Spectra300 休息周';
      lines.push('BEGIN:VEVENT');
      lines.push('UID:'+ymd+'-'+i+'@ems-v2');
      lines.push('DTSTAMP:'+dtstamp);
      lines.push('DTSTART;VALUE=DATE:'+ymd);
      const dt=new Date(parseInt(y),parseInt(m)-1,parseInt(d)+1);
      lines.push('DTEND;VALUE=DATE:'+dt.getFullYear()+pad(dt.getMonth()+1)+pad(dt.getDate()));
      lines.push('SUMMARY:'+summary);
      lines.push('DESCRIPTION:'+tag);
      lines.push('END:VEVENT');
    });
  });
  lines.push('END:VCALENDAR');
  const blob=new Blob([lines.join('\r\n')],{type:'text/calendar;charset=utf-8'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='ems-schedule-202509-202512.ics';
  a.click();
  URL.revokeObjectURL(a.href);
});

</script>
</body>
</html>
